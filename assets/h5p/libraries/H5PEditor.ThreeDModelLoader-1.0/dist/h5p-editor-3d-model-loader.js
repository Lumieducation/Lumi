!function(){"use strict";let e=function(){function e(){this.remainingFilesToProcess=0,this.files=[],this.fileblobs=[],this.glbfilename,this.gltf,this.outputBuffers,this.bufferMap,this.bufferOffset,this.gltfMimeTypes={"image/png":["png"],"image/jpeg":["jpg","jpeg"],"text/plain":["glsl","vert","vs","frag","fs","txt"],"image/vnd-ms.dds":["dds"]}}var t=e.prototype;return t.convert=function(e,t){if(e&&"function"==typeof t){this.callback=t,this.remainingFilesToProcess=e.length;for(let i=0;i<e.length;i++){let r;if(e[i].getAsEntry?r=e[i].getAsEntry():e[i].webkitGetAsEntry&&(r=e[i].webkitGetAsEntry()),r){if(r.isFile)return void t({error:H5PEditor.t("H5PEditor.ThreeDModelLoader","notAFolder")});this.traverseFileTree(r)}}}},t.traverseFileTree=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(e.isFile)e.file((e=>{this.files.push(e);if("gltf"===e.name.split(".").pop()){this.glbfilename=e.name.substr(e.name.lastIndexOf("/")+1,e.name.lastIndexOf("."));const t=new FileReader;t.readAsText(e),t.onload=e=>{this.gltf=JSON.parse(e.target.result),this.checkForDone()}}else{const t=new FileReader;t.onload=(e=>t=>{this.fileblobs[e.name.toLowerCase()]=t.target.result,this.checkForDone()})(e),t.readAsArrayBuffer(e)}}),(e=>{this.callback({error:e})}));else if(e.isDirectory){e.createReader().readEntries((i=>{this.remainingFilesToProcess+=i.length,this.checkForDone();for(let r=0;r<i.length;r++)this.traverseFileTree(i[r],t+e.name+"/")}))}},t.checkForDone=function(){this.remainingFilesToProcess--,0===this.remainingFilesToProcess&&(this.outputBuffers=[],this.bufferMap=new Map,this.bufferOffset=0,this.processBuffers().then((()=>{this.callback({file:this.buildOutputFile()})})).catch((e=>{this.callback({error:e})})))},t.processBuffers=function(){if(!this.gltf)return Promise.reject(H5PEditor.t("H5PEditor.ThreeDModelLoader","noGLTFFound"));const e=this.gltf.buffers.map(((e,t)=>this.getDataFromUri(e).then((i=>{void 0!==i&&this.outputBuffers.push(i),delete e.uri,e.byteLength=i.byteLength,this.bufferMap.set(t,this.bufferOffset),this.bufferOffset+=this.getAlignedLength(i.byteLength)}))));return Promise.all(e).then((()=>{let e=this.gltf.buffers.length;const t=(this.gltf.images||[]).map((t=>this.getDataFromUri(t).then((i=>{if(void 0===i)return void delete t.uri;var r={buffer:0,byteOffset:this.bufferOffset,byteLength:i.byteLength};this.bufferMap.set(e,this.bufferOffset),e++,this.bufferOffset+=this.getAlignedLength(i.byteLength);const o=this.gltf.bufferViews.length;this.gltf.bufferViews.push(r),this.outputBuffers.push(i),t.bufferView=o,t.mimeType=this.getMimeType(t.uri),delete t.uri}))));return Promise.all(t)}))},t.buildOutputFile=function(){for(let e=0,t=this.gltf.bufferViews;e<t.length;e++){const i=t[e];void 0===i.byteOffset?i.byteOffset=0:i.byteOffset=i.byteOffset+this.bufferMap.get(i.buffer),i.buffer=0}const e=this.bufferOffset;this.gltf.buffers=[{byteLength:e}];const t=(new TextEncoder).encode(JSON.stringify(this.gltf)),i=this.getAlignedLength(t.length);let r;i!==t.length&&(r=i-t.length);const o=20+i+8+e,n=new ArrayBuffer(o),s=new DataView(n);let a=0;s.setUint32(a,1179937895,!0),a+=4,s.setUint32(a,2,!0),a+=4,s.setUint32(a,o,!0),a+=4,s.setUint32(a,i,!0),a+=4,s.setUint32(a,1313821514,!0),a+=4;for(let e=0;e<t.length;e++)s.setUint8(a,t[e]),a++;if(void 0!==r)for(let e=0;e<r;e++)s.setUint8(a,32),a++;s.setUint32(a,e,!0),a+=4,s.setUint32(a,5130562,!0),a+=4;for(let e=0;e<this.outputBuffers.length;e++){const t=a+this.bufferMap.get(e),i=new Uint8Array(this.outputBuffers[e]);let r=t;for(let e=0;e<i.byteLength;e++)s.setUint8(r,i[e]),r++}return new Blob([n],{type:"model/json-binary"})},t.isBase64=function(e){return!(e.length<5)&&"data:"===e.substr(0,5)},t.decodeBase64=function(e){return fetch(e).then((e=>e.arrayBuffer()))},t.getDataFromUri=function(e){if(void 0===e.uri)return Promise.resolve();if(this.isBase64(e.uri))return this.decodeBase64(e.uri);{const t=e.uri.substr(e.uri.lastIndexOf("/")+1);return Promise.resolve(this.fileblobs[t.toLowerCase()])}},t.getAlignedLength=function(e){if(0===e)return e;const t=e%4;return 0===t?e:e+(4-t)},t.getMimeType=function(e){for(let i in this.gltfMimeTypes)for(let r in this.gltfMimeTypes[i]){var t=this.gltfMimeTypes[i][r];if(e.toLowerCase().split(".").pop()===`${t}`)return i}return"application/octet-stream"},e}();var t=e;var i=function(){function e(e){this.callback=e||(()=>{}),this.converter=this.converter||new t,this.container=document.createElement("div"),this.container.classList.add("h5peditor-3d-model-loader-converter-container"),this.container.classList.add("h5peditor-3d-model-loader-display-none");const i=document.createElement("div");i.classList.add("h5peditor-3d-model-loader-converter-dropzone"),i.innerText=H5PEditor.t("H5PEditor.ThreeDModelLoader","dropFolderHere"),i.addEventListener("dragover",(e=>{this.handleDragOver(e)}),!1),i.addEventListener("drop",(e=>{this.handleDrop(e)}),!1),this.container.appendChild(i)}var i=e.prototype;return i.getDOM=function(){return this.container},i.show=function(){this.container.classList.remove("h5peditor-3d-model-loader-display-none")},i.hide=function(){this.container.classList.add("h5peditor-3d-model-loader-display-none")},i.handleDragOver=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},i.handleDrop=function(e){e.stopPropagation(),e.preventDefault(),this.converter.convert(e.dataTransfer.items,(e=>{this.callback(e)}))},e}();let r=function(){function e(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.params=e||{},this.params.plane=this.params.plane||!1,this.callbacks=t||{},this.callbacks.onIframeComplete=t.onIframeComplete||(()=>{}),this.iframe=this.buildIframe()}var t=e.prototype;return t.getDOM=function(){return this.iframe},t.buildIframe=function(){const e=document.createElement("iframe");return e.classList.add("h5peditor-3d-model-loader-preview-iframe"),e.addEventListener("load",(()=>{this.iframeLoaded||(this.handleIframeLoaded(this.iframe),this.iframeLoaded=!0)})),e},t.handleIframeLoaded=function(e){try{const t=e.contentWindow;e.contentWindow.document.open(),e.contentWindow.document.write(this.buildHTML().outerHTML),e.contentWindow.document.close(),this.iframeDocument=e.contentDocument?e.contentDocument:t,this.handleIframeWritten()}catch(e){}},t.buildHTML=function(){const e=document.createElement("html");return e.appendChild(this.buildHeader()),e.appendChild(this.buildBody()),e},t.buildHeader=function(){const e=document.createElement("head"),t=document.createElement("script");t.text=H5P.AFrame.toString(),e.appendChild(t);const i=document.createElement("script");i.text=H5P.AFrameOrbitControls.toString(),e.appendChild(i);const r=document.createElement("script");return r.text="H5PAFrame();",r.text+="H5PAFrameOrbitControls();",e.appendChild(r),e},t.buildBody=function(){const e=document.createElement("body");return e.style.background='url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAABhGlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TtVIqDnYQcQhSnSxIFXHUKhShQqgVWnUwufQLmjQkKS6OgmvBwY/FqoOLs64OroIg+AHi5Oik6CIl/i8ptIj14Lgf7+497t4BQr3MNKtrAtB020wl4mImuyoGXtGDEIKIYURmljEnSUl0HF/38PH1LsqzOp/7c/SpOYsBPpF4lhmmTbxBPL1pG5z3icOsKKvE58TjJl2Q+JHrisdvnAsuCzwzbKZT88RhYrHQxkobs6KpEU8RR1RNp3wh47HKeYuzVq6y5j35C0M5fWWZ6zSHkcAiliBBhIIqSijDRpRWnRQLKdqPd/APuX6JXAq5SmDkWEAFGmTXD/4Hv7u18pMxLykUB7pfHOdjFAjsAo2a43wfO07jBPA/A1d6y1+pAzOfpNdaWuQI6N8GLq5bmrIHXO4Ag0+GbMqu5Kcp5PPA+xl9UxYYuAWCa15vzX2cPgBp6ip5AxwcAmMFyl7v8O7e9t7+PdPs7weB03KtCTN/SAAAAAlwSFlzAAAuIwAALiMBeKU/dgAAAAd0SU1FB+QGDAsAMkAVB00AAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAPklEQVRIx2M8ceIEAynA1NSUJPVMDDQGoxaMWjBqwagFoxZQAzD+/fuXJA2k1h+jcTBqwagFoxaMWjAkLAAAEQ8IhUX6aEEAAAAASUVORK5CYII=")',e.style.margin="0",e.style.overflow="hidden",e.style.padding="0",e.style.height="100%",e.style.width="100%",e.appendChild(this.buildScene()),e},t.buildScene=function(){const t=document.createElement("a-scene");t.setAttribute("embedded",""),t.setAttribute("vr-mode-ui","false");const i=document.createElement("a-entity"),r=document.createElement("a-gltf-model");if(r.setAttribute("id","model"),i.appendChild(r),t.appendChild(i),this.params.plane){const i=document.createElement("a-plane");i.setAttribute("id","markerPlane"),i.setAttribute("position",`${e.DEFAULT_OFFSET.x} ${e.DEFAULT_OFFSET.y} ${e.DEFAULT_OFFSET.z}`),i.setAttribute("rotation","-90 0 0"),i.setAttribute("width","1"),i.setAttribute("height","1"),i.setAttribute("src",e.DEFAULT_TEXTURE),i.setAttribute("shadow",""),t.appendChild(i)}const o=document.createElement("a-entity");return o.setAttribute("camera",""),o.setAttribute("look-controls",""),o.setAttribute("orbit-controls","initialPosition: 0 0 2; enableKeys: false;"),t.appendChild(o),t},t.handleIframeWritten=function(){"complete"!==this.iframeDocument.readyState?this.iframeDocument.addEventListener("readystatechange",(()=>{"complete"===this.iframeDocument.readyState&&this.handleIframeCompleted()})):this.handleIframeCompleted()},t.handleIframeCompleted=function(){this.model=this.iframeDocument.querySelector("#model"),this.markerPlane=this.iframeDocument.querySelector("#markerPlane"),this.isInitialized=!0,this.callbacks.onIframeComplete()},t.show=function(){this.iframe.classList.remove("h5peditor-3d-model-loader-display-none")},t.hide=function(){this.iframe.classList.add("h5peditor-3d-model-loader-display-none")},t.setMarkerTexture=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.DEFAULT_TEXTURE;this.isInitialized&&this.markerPlane&&this.markerPlane.setAttribute("src",t)},t.setModel=function(e,t){if(!this.isInitialized)return;if(!e)return void this.model.setAttribute("visible",!1);const i=document.createElement("div");H5P.setSource(i,{path:e},H5PEditor.contentId);const r=i.src;r&&(this.model.setAttribute("gltf-model",r),t&&t.scale&&this.setModelScale(t.scale),t&&t.position&&this.setModelPosition(t.position),t&&t.rotation&&this.setModelRotation(t.rotation),this.model.setAttribute("visible",!0))},t.setModelScale=function(e){this.isInitialized&&e&&(e=Math.max(.01,e),this.model.setAttribute("scale",`${e} ${e} ${e}`))},t.setModelPosition=function(t){if(!this.isInitialized||!t)return;const i=t.x+e.DEFAULT_OFFSET.x,r=t.y+e.DEFAULT_OFFSET.y,o=t.z+e.DEFAULT_OFFSET.z;this.model.setAttribute("position",`${i} ${r} ${o}`)},t.setModelRotation=function(e){this.isInitialized&&e&&this.model.setAttribute("rotation",`${e.x} ${e.y} ${e.z}`)},e}();r.DEFAULT_OFFSET={x:0,y:-1,z:0},r.DEFAULT_TEXTURE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9btSoVBzOIOGSogmBBVMRRq1CECqFWaNXB5NIPoUlDkuLiKLgWHPxYrDq4OOvq4CoIgh8gTo5Oii5S4v+SQosYD4778e7e4+4dEKyVmGa1jQGabpupRFzMZFfE8Cs6EIGAEXTJzDJmJSkJ3/F1jwBf72I8y//cn6NHzVkMCIjEM8wwbeJ14qlN2+C8TyywoqwSnxOPmnRB4keuKx6/cS64HOSZgplOzRELxGKhhZUWZkVTI54kjqqaTvnBjMcq5y3OWqnCGvfkL4zk9OUlrtMcRAILWIQEEQoq2EAJNmK06qRYSNF+3Mc/4Polcink2gAjxzzK0CC7fvA/+N2tlZ8Y95IicaD9xXE+hoDwLlCvOs73sePUT4DQM3ClN/3lGjD9SXq1qUWPgN5t4OK6qSl7wOUO0P9kyKbsSiGawXweeD+jb8oCfbdA96rXW2Mfpw9AmrpK3gAHh8BwgbLXfN7d2drbv2ca/f0ARjFylR0Z2fIAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfkBgwUKTdjQ4hkAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAAxJREFUCNdj+P//PwAF/gL+3MxZ5wAAAABJRU5ErkJggg==";var o=r;var n=function(){function e(e,t,r,n){this.parent=e,this.field=t,this.params=r,this.setValue=n,this.field.threeDModelLoader=this.field.threeDModelLoader||{},this.field.threeDModelLoader.fileTypeExtensions=this.field.threeDModelLoader.fileTypeExtensions||["gltf","glb"],this.field.threeDModelLoader.geometryPath=this.field.threeDModelLoader.geometryPath||"",this.field.threeDModelLoader.planePatternPath=this.field.threeDModelLoader.planePatternPath||"",this.canPreview=-1===window.navigator.userAgent.indexOf("Trident/"),this.canConvert=-1===window.navigator.userAgent.indexOf("Trident/"),this.queue=[],this.$container=H5P.jQuery("<div>",{class:"field h5peditor-3d-model-loader-container"});const s=this.field.type;if(this.fieldInstance=new H5PEditor.widgets[s](e,t,r,n),this.fieldInstance.appendTo(this.$container),this.$errors=this.$container.children().children(".h5p-errors"),this.canPreview){this.preview=new o({plane:""!==this.field.threeDModelLoader.planePatternPath},{onIframeComplete:()=>{this.handleIframeCompleted()}}),this.filePreview=this.fieldInstance.$file.get(0),this.modelPreview=document.createElement("div"),this.modelPreview.classList.add("h5peditor-3d-model-loader-preview-wrapper"),this.modelPreview.classList.add("h5peditor-3d-model-loader-display-none"),this.modelPreview.appendChild(this.preview.getDOM()),this.filePreview.parentNode.insertBefore(this.modelPreview,this.filePreview);const e=document.createElement("button");if(e.classList.add("h5peditor-3d-model-loader-button-remove-model"),e.addEventListener("click",(()=>{this.fieldInstance.confirmRemovalDialog.show(H5P.jQuery(e).offset().top)})),this.fieldInstance.confirmRemovalDialog.on("confirmed",(()=>{this.filePreview.classList.remove("h5peditor-3d-model-loader-display-none")})),this.modelPreview.append(e),this.field.threeDModelLoader.planePatternPath){const e=H5PEditor.findField(this.field.threeDModelLoader.planePatternPath,this.parent);e&&(e.on("removedMarkerPattern",(()=>{this.preview.setMarkerTexture()})),e.on("addedMarkerPattern",(e=>{this.preview.setMarkerTexture(e.data),this.previewQueuePlane=e.data})))}}this.parent.ready((()=>{if(this.canConvert){this.dropzone=this.dropzone||new i((e=>{this.handleConversionDone(e)}));const e=this.$container.get(0);e.parentNode.insertBefore(this.dropzone.getDOM(),e.nextSibling)}const e=this.field.threeDModelLoader.geometryPath;""!==this.field.threeDModelLoader.geometryPath&&(this.rowScale=H5PEditor.findField(`${e}/scale`,this.parent),this.rowScale&&this.canPreview&&this.rowScale.on("changed",(e=>{this.preview.setModelScale(parseFloat(e.data.scale)/100)})),this.rowPosition=H5PEditor.findField(`${e}/position`,this.parent),this.rowPosition&&this.canPreview&&this.rowPosition.on("changed",(e=>{this.preview.setModelPosition({x:parseFloat(e.data.x),y:parseFloat(e.data.y),z:parseFloat(e.data.z)})})),this.rowRotation=H5PEditor.findField(`${e}/rotation`,this.parent),this.rowRotation&&this.canPreview&&this.rowRotation.on("changed",(e=>{this.preview.setModelRotation({x:parseFloat(e.data.x),y:parseFloat(e.data.y),z:parseFloat(e.data.z)})})))})),this.changes=[],this.fileIcon=document.createElement("div"),this.fileIcon.classList.add("h5peditor-3d-model-loader-file-icon"),H5PEditor.followField(this.parent,this.field.name,(e=>{if(!e||!e.path)return void this.resetModel();const t=e.path.split(".").pop().toLowerCase();-1!==this.field.threeDModelLoader.fileTypeExtensions.indexOf(t)&&(this.setModel(e.path),this.previewQueueModel=e.path)})),this.fieldInstance.on("uploadProgress",(()=>{this.canPreview&&(this.preview.hide(),this.modelPreview.classList.add("h5peditor-3d-model-loader-display-none")),this.resetGeometry()})),this.fieldInstance.changes.push((e=>{e?this.handleFileUploaded(e.path):this.resetModel()}))}var t=e.prototype;return t.resetGeometry=function(){[this.rowScale,this.rowPosition,this.rowRotation].forEach((e=>{e&&e.children.forEach((e=>{e.$input.val(e.field.default),e.$input.change()}))}))},t.resetModel=function(){this.canPreview&&(this.preview.setModel(),this.preview.hide(),this.modelPreview.classList.add("h5peditor-3d-model-loader-display-none")),this.resetGeometry()},t.setModel=function(e){if(this.canConvert&&this.dropzone.hide(),this.canPreview)this.filePreview.classList.add("h5peditor-3d-model-loader-display-none"),this.preview.setModel(e,this.getGeometry()),this.preview.show(),this.modelPreview.classList.remove("h5peditor-3d-model-loader-display-none");else{this.filePreview.classList.remove("h5peditor-3d-model-loader-display-none");const t=e.replace(/#tmp$/,"").split(".").pop().toLowerCase();this.showFileIcon(t)}},t.getGeometry=function(){return{scale:parseFloat(this.rowScale.children[0].$input.val())/100,position:{x:parseFloat(this.rowPosition.children[0].$input.val()),y:parseFloat(this.rowPosition.children[1].$input.val()),z:parseFloat(this.rowPosition.children[2].$input.val())},rotation:{x:parseFloat(this.rowRotation.children[0].$input.val()),y:parseFloat(this.rowRotation.children[1].$input.val()),z:parseFloat(this.rowRotation.children[2].$input.val())}}},t.handleIframeCompleted=function(){this.previewQueuePlane&&this.preview.setMarkerTexture(this.previewQueuePlane),this.previewQueueModel&&this.setModel(this.previewQueueModel)},t.handleFileUploaded=function(e){const t=e.split("#").slice(0,-1).join("#").split(".").slice(-1)[0].toLowerCase();if(-1===this.field.threeDModelLoader.fileTypeExtensions.indexOf(t))return this.$errors.append(H5PEditor.createError(H5PEditor.t("H5PEditor.ThreeDModelLoader","filetypeNotSupported"))),this.removeFile(),void(this.canConvert&&this.dropzone.hide());if("gltf"===t){const t=document.createElement("div");H5P.setSource(t,{path:e},H5PEditor.contentId);const r=t.src;try{var i=new XMLHttpRequest;i.open("GET",r),i.onreadystatechange=()=>{if(4===i.readyState){try{const e=JSON.parse(i.responseText);if(!this.isGLTFVersionTwo(e))return void this.handleError(H5PEditor.t("H5PEditor.ThreeDModelLoader","onlyVersionTwo"));if(!this.isGLTFEmbeddedFormat(e))return void(this.canConvert?(this.handleError(H5PEditor.t("H5PEditor.ThreeDModelLoader","onlyEmbeddedAssets")),this.handleEmbeddedAssets()):this.handleError(H5PEditor.t("H5PEditor.ThreeDModelLoader","browserCannotConvert")))}catch(e){return void this.handleError(`${H5PEditor.t("H5PEditor.ThreeDModelLoader","fileDamaged")} (${e})`)}this.setModel(e)}},i.send()}catch(e){return void this.handleError(`${H5PEditor.t("H5PEditor.ThreeDModelLoader","fileDamaged")} (${e})`)}}else this.setModel(e)},t.handleEmbeddedAssets=function(){this.canConvert&&this.dropzone.show()},t.handleConversionDone=function(e){e.error?this.handleError(`${H5PEditor.t("H5PEditor.ThreeDModelLoader","conversionError")} (${e.error})`):(this.fieldInstance.upload(e.file,"foo.glb"),this.canConvert&&this.dropzone.hide())},t.isGLTFEmbeddedFormat=function(e){return!this.findObjects(e,"uri","").some((e=>"data:"!==e.uri.substr(0,5)))},t.isGLTFVersionTwo=function(e){return!this.findObjects(e,"version","").some((e=>"1.0"===e.version))},t.findObjects=function(e,t,i){let r=[];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&("object"==typeof e[o]?r=r.concat(this.findObjects(e[o],t,i)):(o===t&&e[o]===i||o===t&&""===i||e[o]===i&&""===t&&-1===r.lastIndexOf(e))&&r.push(e));return r},t.handleError=function(e){this.$errors.empty(),this.$errors.append(H5PEditor.createError(e)),this.removeFile()},t.removeFile=function(){delete this.fieldInstance.params,this.fieldInstance.setValue(this.fieldInstance.field),this.fieldInstance.addFile();for(var e=0;e<this.fieldInstance.changes.length;e++)this.fieldInstance.changes[e]()},t.showFileIcon=function(e){const t=i=>{if((i=i||500)<=0)return;const r=this.fieldInstance.$file.find("img").get(0);r?(this.fileIcon.title=e,this.fileIcon.innerText=e,r.style.display="none",this.fieldInstance.$file.find(".thumbnail").get(0).appendChild(this.fileIcon)):setTimeout((()=>{t(i-20)}),20)};t()},t.appendTo=function(e){this.$container.appendTo(e)},t.validate=function(){return this.fieldInstance.validate()},t.remove=function(){this.$container.remove()},e}();H5PEditor.widgets.threeDModelLoader=n}();